#!/bin/bash
#
#******************************************************************************
# pack (Sequencer64)
#------------------------------------------------------------------------------
##
# \file       	pack
# \library    	Sequencer64
# \author     	Chris Ahlstrom
# \date       	2015-09-10
# \update     	2017-11-05
# \version    	$Revision$
# \license    	$XPC_SUITE_GPL_LICENSE$
#
#  Packs up the current project directory, ignoring some of the derived
#  junk and the version-control infrastructure.
#
#  Run "./pack --help" for more information.
#
#  Now updated to allow some artifacts generated by bootstrap to be included,
#  so that a conventional "GNU configure" tarfile can be generated.  If you do
#  not want that, do a "./bootstrap --full-clean" first.
#
#-----------------------------------------------------------------------------

CURRENTDATE=`date +%Y-%m-%d`
CURRENTDIR=`pwd`
WORKINGDIR=${CURRENTDIR##/*/}       # strip all but last part of path

# TAGSTRING="git"

TAGSTRING="pack"
DODRYRUN="no"
DOCLEAN="no"

BRANCH=`git symbolic-ref -q HEAD 2> /dev/null`

if [ $? == 0 ] ; then

   ISGITBRANCH="yes"
   GITBRANCH=${BRANCH##*/}

else

   ISGITBRANCH="no"
   GITBRANCH=""

fi

if [ "$1" == "--help" ] || [ "$1" == "help" ] ; then

   echo
   echo "pack 0.3 edited on 2017-11-05"
   echo
   echo "Usage:  ./pack [--dry-run] [--clean] [tag]"
   echo
   echo "where tag is alternate information you want to include in the"
   echo "name of the tarball; it replaces the current date."
   echo
   echo "This script packs the contents of the current directory into a"
   echo "tarball that has the name of the directory and other information"
   echo "as part of the filename."
   echo
   echo "This script packs the entire current directory ('$WORKINGDIR') into"
   echo "a file named like the following (using no tag as an example):"
   echo
   echo "   $WORKINGDIR-master-$TAGSTRING-my-code.tar.xz"
   echo "   $WORKINGDIR-$TAGSTRING-my-code.tar.xz"
   echo
   echo "Excluded from the tarball are derived products such as the 'Debug',"
   echo "'Release', 'html', and 'latex' directories, as well as object"
   echo "modules and the database/symbol files generated by Visual Studio"
   echo "or Borland.  Version-control-system directories are also ignored."
   echo
   echo "This script also detects the presence of a git branch, and incorporates"
   echo "the branch name into the name of the tarball."
   echo
   echo "Finally, it will pack up configure, the Makefile.in files, and other"
   echo "necessary files if they are present.  Do './bootstrap --full-clean'"
   echo "first, or './pack --clean', if you don't want these files."
   echo

else

   while [ "$1" != "" ] ; do

      case "$1" in
      
#        Although this option is no longer needed, keep it around as an
#        undocumented feature just in case the user wants to override the
#        git discovery.

        --branch | --git)
            ISGITBRANCH="yes"
            shift
            GITBRANCH="$1"
            ;;

        --dry-run)
            DODRYRUN="yes"
            ;;

        --clean)
            DOCLEAN="yes"
            ;;

        --no-clean)
            DOCLEAN="no"
            ;;

        *)
            TAGSTRING="$1"
            ;;

      esac

      shift

   done

   if [ "$ISGITBRANCH" == "yes" ] ; then
      TARBALLNAME="$WORKINGDIR-$GITBRANCH-$CURRENTDATE-$TAGSTRING.tar.xz"
   else
      TARBALLNAME="$WORKINGDIR-$CURRENTDATE-$TAGSTRING.tar.xz"
   fi

   echo "The tar-ball to be generated is '../$TARBALLNAME'..."

   if [ "$DODRYRUN" == "yes" ] ; then
      if [ "$DOCLEAN" == "yes" ] ; then
         echo "Sequencer64 will be cleaned by 'bootstrap --full-clean'."
      fi
      echo "Would run 'tar cJf $TARBALLNAME ... $WORKINGDIR '"
      exit 1
   fi

   if [ "$DOCLEAN" == "yes" ] ; then
      ./bootstrap --full-clean
   fi

   pushd ..
   if [ -d $WORKINGDIR ] ; then

# Others that mostly, but not always, are not needed, and so aren't excluded
# at this time:
#
# Makefile
# Makefile.in
# Linux executable files
# --exclude="aux-files"
#
# Removed the slash after WORKINGDIR, and moved it to the end, which
# now allows tar to not include .git in the archive, saving a lot of time
# and space.

   tar cJf $TARBALLNAME \
 --exclude-vcs         \
 --exclude=".git"      \
 --exclude="src/seq24" \
 --exclude="src/sequencer64" \
 --exclude="config.status"  \
 --exclude="libtool"   \
 --exclude="Makefile"  \
 --exclude="Debug"     \
 --exclude="Release"   \
 --exclude="debug"     \
 --exclude="release"   \
 --exclude="autom4te.cache" \
 --exclude="core"      \
 --exclude="moc"       \
 --exclude="obj"       \
 --exclude="html"      \
 --exclude="ipch"      \
 --exclude="latex"     \
 --exclude="out.*"     \
 --exclude=".deps"     \
 --exclude=".exes"     \
 --exclude=".libs"     \
 --exclude="*.a"       \
 --exclude="*.bak"     \
 --exclude="*.BAK"     \
 --exclude="*.bpi"     \
 --exclude="*.bz2"     \
 --exclude="*.deps"    \
 --exclude="*.bz"      \
 --exclude="*.idb"     \
 --exclude="*.ilc"     \
 --exclude="*.ild"     \
 --exclude="*.ilf"     \
 --exclude="*.o"       \
 --exclude="*.lo"      \
 --exclude="*.la"      \
 --exclude="*.lib"     \
 --exclude="*.log"     \
 --exclude="*.obj"     \
 --exclude="*.pch"     \
 --exclude="*.pdb"     \
 --exclude="*.Po"      \
 --exclude="*.sdf"     \
 --exclude="*.so"      \
 --exclude="*.swp"     \
 --exclude=".*.swp"    \
 --exclude="*.t"       \
 --exclude="*.tds"     \
 --exclude="*.tmp"     \
 --exclude="*.user"    \
 --exclude="*.xz"      \
 --exclude="*.testsettings" \
   $WORKINGDIR

      echo

   else

      echo "? Working directory $WORKINGDIR does not exist above this directory."
      echo "  Are you running pack.sh from the proper directory?"
      echo "  That is what you must do.  See './pack --help'."

   fi

   popd

fi

#******************************************************************************
# pack (Sequencer64)
#------------------------------------------------------------------------------
# vim: ts=3 sw=3 et ft=sh
#------------------------------------------------------------------------------
